#!/bin/bash

echo "=== Testing AltoniumOS Disk I/O ==="
echo

# Create a test disk with a known pattern
echo "Creating test disk with known pattern..."
dd if=/dev/zero of=test_disk.img bs=512 count=100 2>/dev/null

# Write a simple pattern to the first sector
echo "Writing test pattern to first sector..."
printf "ALTONIUMOS_DISK_TEST_1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567878" > test_sector.bin

# Pad to 512 bytes
dd if=test_sector.bin of=test_disk.img bs=512 count=1 conv=notrunc 2>/dev/null

echo "Test disk created."
echo

# Test with direct kernel boot and disk attached
echo "Testing kernel boot with disk I/O..."
echo "Note: This will start QEMU. The kernel should initialize the disk driver."
echo "You should see disk initialization messages."
echo

# Start QEMU in background
qemu-system-i386 -kernel dist/kernel.elf -drive format=raw,file=test_disk.img,if=ide -nographic &
QEMU_PID=$!

# Wait a bit for boot
sleep 8

# Kill QEMU
kill $QEMU_PID 2>/dev/null

echo
echo "Disk I/O test completed."
echo "If you saw disk initialization messages above, the disk driver is working!"
echo
echo "To test interactively, run:"
echo "qemu-system-i386 -kernel dist/kernel.elf -drive format=raw,file=test_disk.img,if=ide"
echo "Then type 'disk' at the prompt."